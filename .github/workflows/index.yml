name: GitRag Indexing

on:
  push:
    branches: [ "**" ] # Trigger on all branch pushes
  workflow_dispatch:   # Allow manual triggering

jobs:
  index-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Required: Fetch history so Indexer.py can run 'git diff'
          fetch-depth: 0 

      - name: Restore Model Cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-gitrag-models

      - name: Run GitRag Indexer
        # Replace 'main' with the specific branch/tag of GitRag you want to use
        uses: dorphalsig/gitrag@main 
        with:
          repo: ${{ github.repository }}
          branch: ${{ github.ref_name }}
          turso_database_url: ${{ secrets.TURSO_DATABASE_URL }}
          turso_auth_token: ${{ secrets.TURSO_AUTH_TOKEN }}
          full_index: "false" # Set to 'true' for the initial manual run